# 图解TCP/IP

##### OSI参考模型

![TIM截图20190417155136](I:\桌面\截图\TIM截图20190417155136.png)

##### 协议分层

​	每个分层都接受由他下一层所提供的特定服务，并且负责为自己的上一层提供特定的服务。上下层之间进行交互式遵循的约定叫做“接口”。同层之间的交互所遵循的约定叫做“协议”。

​	分层的好处：每个分层都可以独立使用，及时系统中某些分层发生变化，也不会波及整个系统。因此扩展性和灵活性都较强。分层也细分了通信功能，更易于单独实现每个分层的协议。

​	分层的劣势：由于过于模块化，使处理变得更加沉重，以及每个模块不得不实现一些相似的逻辑。

![TIM截图20190417184425](I:\桌面\截图\TIM截图20190417184425.png)

1. **应用层** ：为应用程序提供服务，并且规定应用程序中通信相关的细节，协议。


2. **表示层** ：将应用层的信息转换为适合网络传输的格式，或者将下层的信息转换为上层能够处理的格式。

3. **会话层** ：负责建立和断开链接，数据分割等 数据传输相关内容。

4. **传输层** ：起着可靠传输的作用，只在通信双方的节点上处理，无需通过路由处理。

   ​		传输层为了确保所传输的数据到达目标地址，会在通信两端的计算机进行确认，如果数据没有到达，它会重发。

5. **网络层** ：将数据传输到目标地址，这一层主要负责寻址和路由选择。

6. **数据链路层** ：负责物理层面上的互联，节点通信。

7. **物理层** ：负责0,1比特流。

在TCP/IP中，网络层与传输层相互协作以确保数据包能够传送到世界各地，实现可靠传输。

##### 分组交换：

发送端将数据分组发送给路由器，路由器收到这些分组数据以后，缓存到自己的缓冲区，然后转发给目标计算机。



MAC地址和IP地址在标识一个通信主体时虽然都具有唯一性，但是他们当中只有IP地址具有层次性。

MAC地址由设备制造商针对每块网卡进行分别指定。

MAC寻址中所参考的表叫做地址转发表；IP寻址中所参考的表叫做路由控制表。



![TIM截图20190418161503](I:\桌面\截图\TIM截图20190418161503.png)

**互联网层使用IP协议，相当于OSI七层模型中的网络层。**

##### IP

​	ip是跨越网络传送数据包，使整个互联网都能收到数据的协议。ip协议使数据能够发送到地球的另一端，这期间它使用IP地址作为主机的表示。

​	ip还隐含着数据链路层的功能。通过IP,相互通信的主机之间不论经过怎样的底层数据链路都能实现通信；虽然ip也是分组交换协议，但是它不具有重发机制，因此属于非可靠性传输协议。

##### ICMP

​	ip数据包在发送途中一旦发生异常导致无法到达对端目标地址时，需要给发送端发送一个发生异常的通知。有时也被用来检查网络的健康状态。

##### ARP

​	从分组数据包的ip地址中解析出物理地址（MAC地址）的一种协议。

**传输层最主要的功能就是能够让程序之间实现通信**

##### TCP

​	TCP是一种面向有向连接的传输层协议。他可以保证两端通信主机之间的通信可达。TCP可以正确处理传输过程中的丢包、传输顺序乱等情况，还能有效的利用带宽，缓解网络拥堵问题。

​	为了建立（TCP三次握手连接）与断开（断开时需要四次挥手）连接，有时需要至少7次的收包与发包，导致网络流量的浪费。此外，为了提高网络利用率，TCP协议中定义了许多复杂的规则，所以不适用与视频、音频等。

##### UDP

​	UDP是一种面向无向连接的传输层协议。不关注对端是否真的收到了传送过去的数据。UDP常用于分组数据较少或多播、广播通信以及视频通信等多媒体领域。

**应用层（会话层以上的分层）**

##### HTTP（应用层协议）

​	浏览器与服务器之间的通信协议。（HTML是表示层协议）

##### SMTP（表示层）

​	发送电子邮件时用到的协议。

##### FTP

​	文件传输是指将保存在其他计算机硬盘上的文件转移到本地的硬盘上，或者将本地硬盘上的文件发送到其他机器硬盘上；传输过程中可以选择使用二进制方式或者文本的方式；进行文件传输时会建立两个TCP连接。

​	FTP协议约定，一个连接用于传输命令，一个连接用于传输数据。所以用两个连接。数据连接通道又分主动、被动，区别在于发起连接方是服务器端还是客户端。

##### 远程登陆（Telnet与SSH）

​	远程登陆是指登录到远程计算机上，使那台计算机上的程序得以运行的一种功能。

##### 网络管理（SNMP）

​	在TCP/IP中进行网络管理时，采用SNMP协议。使用SNMP管理的主机、网桥、路由等称作SNMP代理（Agent），而进行管理的那一段叫做管理器（Manager）。SNMP正是这个Agent和Manager所要用到的协议。

​	在SNMP的代理端，保存着网络接口的信息、通信数据量、异常数据量以及设备温度信息，可以通过MIB访问。在TCP/IP的网络管理中，SNMP属于应用协议，MIB属于表示协议。

![TIM截图20190422110309](I:\桌面\截图\TIM截图20190422110309.png)

​		每个分层中，都会对所放松的数据附加一个首部，在这个首部中包含了该层的必要信息，如发送的相关地址以及协议信息。

##### 包、帧、数据报、段、消息

​	包可以说是全能性术语。

​	帧用于表示在数据链路层中包的单位。

​	而数据报是IP和UDP等网络层以上的分层中包的单位。

​	段则表示TCP数据流中的信息。

​	消息是指应用协议中数据单位。

##### 包首部是协议的脸

​	网络中传输的数据包由两部分构成：一部分是协议所要用到的首部，另一部分是上层传过来的数据。首部的结构由协议的规范具体定义。例如，识别上一层协议的域应该从包的那一位开始取多少个比特、如何计算校验合并插入包的哪一位等。

![TIM截图20190422151728](I:\桌面\截图\TIM截图20190422151728.png)

​	每个包首部中至少包含两个信息：一个是发送端和接收端地址，另一个是上一层的协议类型。

​	经过每个协议分层时，都必须有识别包发送端和接收端的信息。以太网会用MAC地址，IP会用IP地址，而TCP/UDP则会使用端口号作为识别两端主机的地址。



##### IP地址与MAC地址的差异

1. 对于网络上的某一设备，如一台计算机或一台路由器，其IP地址可变（但必须唯一），而MAC地址不可变。我们可以根据需要给一台主机指定任意的IP地址，如我们可以给局域网上的某台计算机分配IP地址为192.168.0.112 ，也可以将它改成192.168.0.200。而任一网络设备（如网卡，路由器）一旦生产出来以后，其MAC地址永远唯一且不能由用户改变。
2. 长度不同。IP地址为32位，MAC地址为48位。
3. 分配依据不同。IP地址的分配是基于网络拓朴，MAC地址的分配是基于制造商。
4. 寻址协议层不同。IP地址应用于OSI第三层，即网络层，而MAC地址应用在OSI第二层，即数据链路层。 数据链路层协议可以使数据从一个节点传递到相同链路的另一个节点上（通过MAC地址），而网络层协议使数据可以从一个网络传递到另一个网络上（ARP根据目的IP地址，找到中间节点的MAC地址，通过中间节点传送，从而最终到达目的网络）。


![TIM截图20190424162348](I:\桌面\截图\TIM截图20190424162348.png)

​	在全世界，MAC地址并不总是唯一的。实际上，即使MAC地址相同，只要不是同属于一个数据链路就不会出现问题。

​	从通信介质（通信，介质）的使用方法上看，网络共享可以分为**共享介质型**和**非共享介质型**。

##### 共享介质型网络

​	共享介质网络中有两种介质访问控制方式：一种是**争用方式**，一种是**令牌传递方式**。

###### 争用方式

​	争用方式是指获取数据传输的权力，也叫CSMA（载波监听访问多路）。这种方法通常令网络中的各个站（其实就是节点）采用先到先得的方式占用信道发送数据，如果多个站同时发送帧，则会产生冲突现象。也因此会导致网络拥堵与性能下降。

​	在一些网络中，采用CSMA/CD的方式。CSMA/CD要求每个站提前检查冲突，一旦发生冲突，则尽早释放信道：

- 如果载波信道上没有数据流动，则任何站都可以发送数据。
- 检查是否会发生冲突。一旦发生冲突，放弃发送数据，同时立即释放载波信道。
- 放弃发送后，随机延时一段时间，再重新争用介质

![TIM截图20190424164957](I:\桌面\截图\TIM截图20190424164957.png)

###### 令牌传递方式

​	令牌传递方式是沿着令牌环发送一种叫做“令牌”的特殊报文，是控制传输的一种方式。只有获得令牌的站才能发送数据。这种方式有连个特点：一是不会产生冲突；二是每个站都有通过平等循环获得令牌的机会。即使网络拥堵也不会导致性能下降。

​	这种方式，一个站在未收到令牌时不能发送帧，在网络不太拥堵的情况下数据链路利用率不到100%。

![TIM截图20190424173351](I:\桌面\截图\TIM截图20190424173351.png)

##### 非共享介质网络

​	非共享介质网络是指不共享介质，是对介质采取专用的一种传输控制方式。在这种方式下，网络中的每个站直连交换机，由交换机负责转发数据帧。此方式下，发送端与接收端并不共享通信介质。这种方式有一个致命缺点，一旦交换机发生故障，与之相连的计算机都无法通信。

##### 半双工与全双工通信

​	半双工是指，只发送或只接收的通信方式。

​	全双工允许在同一时间既可以发送数据也可以接收数据。

##### 根据MAC地址转发

![TIM截图20190522171746](I:\桌面\截图\TIM截图20190522171746.png)

​	由于MAC地址没有层次性，转发表的入口数与整个数据链路中所有网络设备的数量有关。当网络设备数量很多是，检索转发表就变得困难，所以将网络分为多个数据链路，采用类似网络层的IP地址一样对MAC地址分层管理。

##### 交换机转发方式

​	存储转发：检查数据帧末尾的FCS位之后才转发，可以避免发送由于冲突而被破坏的帧或者噪声导致的错误帧

​	直通转发：不需要将整个帧都接收再转发。延迟低，但是错误帧可能性增加。

##### 环路检测技术

​	环路：数据帧在环路中被一而再再而三的持续转发，这种数据帧越积越多就会导致网络瘫痪。

​	搭建合适的环路，就能分散网络流量，在发生某一处路由故障时选择绕行，提高容灾能力。

###### 	生成树技术:

​	每个网桥必须在1~10秒内相互交换BPDU包，从而判断哪些端口使用，哪些端口不使用，以便消除环路。一旦发生故障，则自动切换通信线路。利用那些没有被使用的端口继续进行传输。以某一个网桥为构造树的根，并且对每一个端口设置权重，指定优先使用哪些端口以及发生问题时该使用哪些端口。

###### 	源路由法

​	该方法判断发送数据的源地址是通过那个网桥实现传输的，并将帧写入RIF。网桥会根据这个RIF信息发送帧给目标地址。因此，即使网桥中出现了环路，数据帧也不会重复转发，可以成功的发送到目标地址。这种机制中发送端必须俱备源路由的功能。

​